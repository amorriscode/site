import Codeblock, {FilenameBlock} from '../../codeblock'
import DocsNote from '../../docsnote'
import { Link } from 'gatsby'
import StorkPostsNunjucks from "./storkpostsnunjucks"

<div>

Stork is compatible with any website, but works especially well with static sites built with a [static site generator](https://www.netlify.com/blog/2020/04/14/what-is-a-static-site-generator-and-3-ways-to-find-the-best-one/) and hosted on static hosting services like [Netlify](https://www.netlify.com). In this guide, we'll learn:

1. How to dynamically generate a Stork configuration file as part of your site's build process,
2. How to build an index using the Stork binary during your site's build process, on the Netlify task runner, and
3. How to load that index and build a search page on your site.

I'll be using my site (https://jameslittle.me) and my static site generator ([Eleventy](https://www.11ty.dev/)) as the example, but the concepts and steps should work for any site and any static site generator, for the most part.

*Problem with this guide? [Let me know!](https://github.com/jameslittle230/stork-site/issues/new)*

# Step 1: Generate the Stork Configuration File

Your static site generator likely lets you build a page that lists out all your "posts" or "pages" or "articles." You might be using that functionality to build a "post archive" page, or perhaps an RSS feed.

We can use that same functionality to build a Stork configuration file. Eleventy lets me write a Nunjucks file that will be used as the template for any arbitrary output file when the site is built. In this Nunjucks file, I'm looping through `collections.post` and adding a new `[[input.files]]` entry with the post's path on disk, the URL path it will ultimately have once it's published, and the post's title.

</div>

I'm also configuring the output file to be located in the `_site` directory: the directory where Eleventy writes the final site.

<StorkPostsNunjucks />

<div>

When Eleventy builds my site, it will create a file at `_site/stork-posts.toml` with the full Stork configuration file.

Next, we'll configure Netlify to generate the Stork index file when it builds the site.

# Step 2: Building the Index

When Netlify builds my site, it usually runs my static site generator to build my site. Now, I want to change what Netlify does so that it: 

1. Runs the Eleventy site generation to build my static pages and my Stork configuration file, then
2. Runs `stork --build` on the generated configuration file to build an index file.

Stork doesn't come preinstalled on Netlify's build machines, so in between steps 1 and 2, we have to install the Stork binary as well.

I'll add the following to a new file called `build.sh` in the root of my project:

</div>

<div className="popout">

<Codeblock filename="build.sh" lang="bash">
    {`#!/usr/bin/env bash
wget https://github.com/jameslittle230/stork/releases/download/v0.8.0/stork-latest-x86_64-unknown-linux-gnu
chmod +x stork-latest-x86_64-unknown-linux-gnu
ELEVENTY_ENV=production npx @11ty/eleventy --config=eleventy.js
./stork-latest-x86_64-unknown-linux-gnu --build _site/stork-posts.toml`}
</Codeblock>

</div>

From top to bottom, this script:

1. Downloads the Stork binary from Github. Each release, a binary built for Ubuntu is automatically compiled and uploaded to the Github release,
2. Makes that downloaded binary executable,
3. Runs Eleventy and builds the site, and
4. Uses the Stork binary to build the generated Stork configuration file.

Netlify lets you choose the **build command** to run when publishing a new version of the site; by default, that command is `yarn build`. We can change it to `./build.sh` so that Netlify will automatically run that script each time our site is deployed.

After I change the Netlify configuration and re-deployed my site, I'll check to make sure Netlify is generating the search index properly. In the configuration file, we set the index file to be built to `https://jameslittle.me/stork-posts.st`, and I can `wget` that URL to confirm that the file has been built and hosted correctly.

# Step 3: Building the Search page

Now that Netlify is automatically building the search index, I can build a static page on my site that will load the Stork interface. I'll add the following page to my site:

<Codeblock filename="search.njk" lang="html">
    {`---
layout: base.njk
permalink: /search/index.html
---
  
<h1>Search</h1>
<link rel="stylesheet" href="https://files.stork-search.net/basic.css" />
  
<div class="stork-wrapper">
  <input data-stork="posts" class="stork-input" />
  <div data-stork="posts-output" class="stork-output"></div>
</div>
  
<script src="https://files.stork-search.net/stork.js"></script>
<script>
  stork.register('posts', '/stork-posts.st');
</script>`}
</Codeblock>


Eleventy will use the default page layout and publish this page to `/search` when it builds the site.

Once I let Netlify build a version of this site with the page, I can visit https://jameslittle.me/search to see a search interface for all the posts in my blog. Moreover, I never have to touch my Stork setup again; this setup dynamically reloads the search index every time I update my site's content, so my search interface is always up to date.

# Next steps

- I have multiple "collections" of content on my site, including a portfolio of projects I've worked on. What would you add to also index the portfolio project descriptions as well?
- What would you change to get the search interface embedded in my site's header or footer, on every page of the site?